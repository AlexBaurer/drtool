<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Layout with Bootstrap</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row vh-100">
            <!-- Left Panel -->
            <div class="col-md-4 col-lg-3 p-3 border-end">
                <div class="input-group mb-3">
                    <input type="text" id="searchInput" class="form-control rounded-pill" placeholder="Search..." aria-label="Search">
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary rounded-circle ms-2 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="width: 38px; height: 38px;" aria-label="Filter">
                            <i class="bi bi-funnel"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><button class="dropdown-item" id="filterDate">By Date</button></li>
                            <li><button class="dropdown-item" id="filterAuthor">By Author</button></li>
                            <li><button class="dropdown-item" id="filterAlphabet">By Alphabet</button></li>
                        </ul>
                    </div>
                </div>
                <div class="d-flex flex-column gap-3 mb-3" id="cardList">
                    <!-- Cards will be dynamically added here -->
                </div>
                <button class="btn btn-outline-primary rounded-circle" style="width: 38px; height: 38px;" aria-label="New Card" data-bs-toggle="modal" data-bs-target="#newCardModal">
                    <i class="bi bi-plus"></i>
                </button>
            </div>

            <!-- Right Panel -->
            <div class="col-md-8 col-lg-9 p-3 d-flex flex-column">
                <div class="p-3 rounded-4 mb-3 border">
                    <input type="text" id="editableCardTitle" class="form-control" disabled>
                </div>
                <div class="p-3 rounded-4 mb-3 flex-grow-1 border">
                    <textarea id="editableCardContent" class="form-control mb-3" rows="10" disabled></textarea>
                    <div class="p-3 rounded-4 border d-flex align-items-center">
                        <small id="dateReview" class="me-2">Review Date: Not Set</small>
                        <button class="btn btn-sm btn-outline-secondary" id="openDatePicker">Edit</button>
                    </div>
                    <button class="btn btn-primary mt-3" id="saveCardButton" disabled>Save Card</button>
                    <button class="btn btn-outline-info mt-3 ms-2" id="viewLogButton">View Log</button>
                </div>
                <div class="p-3 rounded-4 border">
                    <small id="cardMetadata">Card metadata will appear here</small>
                </div>
            </div>
        </div>
    </div>

    <!-- New Card Modal -->
    <div class="modal fade" id="newCardModal" tabindex="-1" aria-labelledby="newCardModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newCardModalLabel">Create New Card</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newCardForm">
                        <div class="mb-3">
                            <label for="newCardTitle" class="form-label">Card Title</label>
                            <input type="text" class="form-control" id="newCardTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="newCardContent" class="form-label">Card Content</label>
                            <textarea class="form-control" id="newCardContent" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newCardReviewDate" class="form-label">Review Date</label>
                            <input type="date" class="form-control" id="newCardReviewDate" required>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNewCard">Save Card</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Modal -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">Card Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="logModalBody">
                    <!-- Logs will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div class="modal fade" id="datePickerModal" tabindex="-1" aria-labelledby="datePickerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="datePickerModalLabel">Select Review Date</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="date" id="reviewDateInput" class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveReviewDate">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cardList = document.getElementById('cardList');
            const searchInput = document.getElementById('searchInput');
            const editableCardTitle = document.getElementById('editableCardTitle');
            const editableCardContent = document.getElementById('editableCardContent');
            const saveCardButton = document.getElementById('saveCardButton');
            const saveNewCardButton = document.getElementById('saveNewCard');
            const viewLogButton = document.getElementById('viewLogButton');
            const cardMetadata = document.getElementById('cardMetadata');
            const filterButton = document.getElementById('filterButton');

            let cards = [
                { id: 1, title: 'Card 1', content: 'This is the content of Card 1', createdAt: '2023-12-10', updatedAt: '2023-12-10', author: 'John Doe' },
                { id: 2, title: 'Card 2', content: 'This is the content of Card 2', createdAt: '2023-12-11', updatedAt: '2023-12-11', author: 'Jane Smith' }
            ];
            let cardLogs = [];
            let currentCard = null;

            function logCardChange(card, action) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    action: action,
                    cardId: card.id,
                    title: card.title,
                    content: card.content
                };
                cardLogs.push(logEntry);
            }

            function renderCards(filter = '') {
                cardList.innerHTML = '';
                cards
                    .filter(card => card.title.toLowerCase().includes(filter.toLowerCase()))
                    .forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'p-3 rounded-4 border card-item';
                        cardElement.textContent = card.title;
                        cardElement.dataset.cardId = card.id;
                        cardList.appendChild(cardElement);
                    });
            }

            cardList.addEventListener('click', function (e) {
                if (e.target.classList.contains('card-item')) {
                    const cardId = parseInt(e.target.dataset.cardId);
                    const selectedCard = cards.find(card => card.id === cardId);
                    if (selectedCard) {
                        currentCard = selectedCard;
                        editableCardTitle.value = selectedCard.title;
                        editableCardContent.value = selectedCard.content;
                        editableCardTitle.disabled = false;
                        editableCardContent.disabled = false;
                        saveCardButton.disabled = false;
                        cardMetadata.textContent = `Created: ${selectedCard.createdAt} | Last Updated: ${selectedCard.updatedAt} | Author: ${selectedCard.author}`;
                        document.getElementById('dateReview').textContent = `Review Date: ${selectedCard.reviewDate}`;
                    }
                }
            });

            saveCardButton.addEventListener('click', function () {
                if (currentCard) {
                    const oldTitle = currentCard.title;
                    const oldContent = currentCard.content;

                    currentCard.title = editableCardTitle.value;
                    currentCard.content = editableCardContent.value;
                    currentCard.updatedAt = new Date().toISOString().split('T')[0];
                    const newReviewDate = document.getElementById('dateReview').value;
                    if (newReviewDate) {
                        currentCard.reviewDate = newReviewDate;
                    }

                    if (!currentCard.logs) {
                        currentCard.logs = []; // Инициализируем массив логов, если он отсутствует
                    }

                    // Добавляем запись в лог
                    currentCard.logs.push({
                        timestamp: new Date().toISOString(),
                        action: 'Updated',
                        oldTitle: oldTitle,
                        newTitle: currentCard.title,
                        oldContent: oldContent,
                        newContent: currentCard.content
                    });

                    renderCards(searchInput.value);
                    alert('Card updated successfully!');
                }
            });

            searchInput.addEventListener('input', function() {
                renderCards(searchInput.value);
            });


            viewLogButton.addEventListener('click', function () {
                if (!currentCard || !currentCard.logs || currentCard.logs.length === 0) {
                    document.getElementById('logModalBody').innerHTML = '<p>No logs available for this card</p>';
                } else {
                    const logModalContent = currentCard.logs
                        .map(log => `
                            <div class="p-2 border-bottom">
                                <strong>Timestamp:</strong> ${log.timestamp}<br>
                                <strong>Action:</strong> ${log.action}<br>
                                <strong>Old Title:</strong> ${log.oldTitle || 'N/A'}<br>
                                <strong>New Title:</strong> ${log.newTitle || 'N/A'}<br>
                                <strong>Old Content:</strong> ${log.oldContent || 'N/A'}<br>
                                <strong>New Content:</strong> ${log.newContent || 'N/A'}<br>
                                <strong>Old Review Date:</strong> ${log.oldReviewDate || 'N/A'}<br>
                                <strong>New Review Date:</strong> ${log.newReviewDate || 'N/A'}<br>
                            </div>
                        `)
                        .join('');
                    document.getElementById('logModalBody').innerHTML = logModalContent;
                }
                new bootstrap.Modal(document.getElementById('logModal')).show();
            });

            saveNewCardButton.addEventListener('click', function () {
                const title = document.getElementById('newCardTitle').value;
                const content = document.getElementById('newCardContent').value;
                const reviewDate = document.getElementById('newCardReviewDate').value;

                if (title && content && reviewDate) {
                    const currentDate = new Date().toISOString().split('T')[0];
                    const newCard = {
                        id: cards.length + 1,
                        title: title,
                        content: content,
                        createdAt: currentDate,
                        updatedAt: currentDate,
                        reviewDate: reviewDate,
                        author: 'Current User',
                        logs: [] // Инициализируем пустой лог
                    };

                    cards.push(newCard);
                    renderCards(searchInput.value);
                    document.getElementById('newCardForm').reset();
                    document.getElementById('newCardModal').hide();
                } else {
                    alert('Please fill in all fields');
                }
            });

            document.getElementById('filterDate').addEventListener('click', function() {
                cards.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                renderCards(searchInput.value);
            });

            document.getElementById('filterAuthor').addEventListener('click', function() {
                cards.sort((a, b) => a.author.localeCompare(b.author));
                renderCards(searchInput.value);
            });

            document.getElementById('filterAlphabet').addEventListener('click', function() {
                cards.sort((a, b) => a.title.localeCompare(b.title));
                renderCards(searchInput.value);
            });

            document.getElementById('openDatePicker').addEventListener('click', function () {
                if (!currentCard) {
                    alert('No card selected to edit.');
                    return;
                }

                // Предзаполнить текущее значение даты пересмотра
                const reviewDateInput = document.getElementById('reviewDateInput');
                reviewDateInput.value = currentCard.reviewDate || '';
                new bootstrap.Modal(document.getElementById('datePickerModal')).show();
            });

            document.getElementById('saveReviewDate').addEventListener('click', function () {
                const reviewDateInput = document.getElementById('reviewDateInput').value;

                if (!reviewDateInput) {
                    alert('Please select a valid date.');
                    return;
                }

                const oldReviewDate = currentCard.reviewDate;
                currentCard.reviewDate = reviewDateInput;

                if (!currentCard.logs) {
                    currentCard.logs = [];
                }

                // Логируем изменение
                currentCard.logs.push({
                    timestamp: new Date().toISOString(),
                    action: 'Review Date Updated',
                    oldReviewDate: oldReviewDate || 'Not Set',
                    newReviewDate: currentCard.reviewDate
                });

                // Обновляем отображение
                document.getElementById('dateReview').textContent = `Review Date: ${currentCard.reviewDate}`;
                alert('Review date updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('datePickerModal')).hide();
            });


            renderCards();
        });
    </script>
</body>
</html>